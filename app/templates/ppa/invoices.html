{% extends "_base.html" %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">Invoices</h1>

<form method="get" class="bg-white p-4 rounded shadow mb-4 flex flex-wrap gap-3 items-end">
  <label class="block">
    <span class="text-sm text-gray-600">Site</span>
    <select name="site_id" class="border p-2 min-w-[220px]">
      <option value="">-- All --</option>
      {% for s in sites %}
        <option value="{{ s.id }}" {% if site_id == s.id %}selected{% endif %}>{{ s.name }}</option>
      {% endfor %}
    </select>
  </label>
  <button class="bg-blue-600 text-white px-4 py-2 rounded">Filter</button>
</form>

<div class="bg-white rounded shadow">
  <table class="w-full text-sm">
    <thead>
      <tr class="border-b">
        <th class="p-2 text-left">#</th>
        <th class="p-2 text-left">Site</th>
        <th class="p-2 text-left">Period</th>
        <th class="p-2 text-right">Total (EUR)</th>
        <th class="p-2 text-left">Status</th>
        <th class="p-2 text-left">Created</th>
        <th class="p-2 text-center">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for inv, site in rows %}
      <tr class="border-b">
        <td class="p-2">{{ inv.id }}</td>
        <td class="p-2">{{ site.name }}</td>
        <td class="p-2">{{ inv.period_start }} â€“ {{ inv.period_end }}</td>
        <td class="p-2 text-right">{{ '%.2f' % inv.total_amount }}</td>
        <td class="p-2">
            {% set color = {
                'draft':'bg-gray-200 text-gray-800',
                'issued':'bg-blue-200 text-blue-800',
                'paid':'bg-green-200 text-green-800',
                'void':'bg-red-200 text-red-800'
                }[inv.status] %}
            <span class="px-2 py-0.5 rounded text-xs font-semibold {{ color }}">{{ inv.status }}</span>
        </td>
        <td class="p-2">{{ inv.created_at }}</td>
        <td class="p-2 text-center whitespace-nowrap">
            <form method="post"
                    action="{{ url_for('ppa.invoice_change_status', iid=inv.id) }}"
                    class="inline">
                <select name="status" class="border text-sm px-1 py-0.5 rounded"
                        onchange="this.form.submit()">
                    {% for s in ['draft','issued','paid','void'] %}
                    <option value="{{ s }}" {% if inv.status == s %}selected{% endif %}>
                        {{ s }}
                    </option>
                    {% endfor %}
                </select>
                </form>
          <a class="text-blue-600 mr-2" href="{{ url_for('ppa.view_invoice', iid=inv.id) }}">View</a>
          <a href="{{ url_for('ppa.export_invoice_csv', iid=inv.id) }}">CSV</a>
            <a href="{{ url_for('ppa.export_invoice_pdf', iid=inv.id) }}">PDF</a>

          <form class="inline" method="post" action="{{ url_for('ppa.invoice_delete', iid=inv.id) }}"
                onsubmit="return confirm('Obrisati Invoice #{{inv.id}}?');">
            <button class="text-red-600">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
      {% if not rows %}
        <tr><td class="p-2" colspan="7">Nema faktura.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>
{% endblock %}
